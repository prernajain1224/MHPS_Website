{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags %}

{% block title %}{{ page.page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="gallery-page-wrapper">
    
    <div class="container">
        
        <!-- Page Header with Search & Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="gallery-header">
                    <div class="row align-items-center">
                        
                        <!-- Page Title -->
                        <div class="col-lg-3 mb-3 mb-lg-0">
                            <h1 class="gallery-page-title mb-0">{{ page.page_title }}</h1>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="col-lg-4 mb-lg-0">
                            <form method="get" class="gallery-search-form">
                                <div class="search-input-wrapper">
                                    <input type="text" 
                                           name="search" 
                                           class="form-control gallery-search-input" 
                                           placeholder="Search images"
                                           value="{{ search_query }}">
                                    <button type="submit" class="search-btn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                
                                <!-- Hidden fields to preserve filters -->
                                {% if date_from %}
                                    <input type="hidden" name="date_from" value="{{ date_from }}">
                                {% endif %}
                                {% if date_to %}
                                    <input type="hidden" name="date_to" value="{{ date_to }}">
                                {% endif %}
                            </form>
                        </div>
                        
                        <!-- Date Filters -->
                        <div class="col-lg-4">
                            <form method="get" id="dateFilterForm" class="date-filter-form">
                                <div class="row g-2 align-items-end">
                                    <div class="col">
                                        <label class="filter-label">FROM</label>
                                        <input type="date" 
                                               name="date_from" 
                                               class="form-control date-input"
                                               value="{{ date_from }}"
                                               placeholder="DD / MM / YYYY">
                                    </div>
                                    <div class="col">
                                        <label class="filter-label">TO</label>
                                        <input type="date" 
                                               name="date_to" 
                                               class="form-control date-input"
                                               value="{{ date_to }}"
                                               placeholder="DD / MM / YYYY">
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary filter-btn">
                                            FILTER
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Hidden field to preserve search -->
                                {% if search_query %}
                                    <input type="hidden" name="search" value="{{ search_query }}">
                                {% endif %}
                            </form>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        {% if search_query or date_from or date_to %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="active-filters">
                        <span class="filter-label-text">Active filters:</span>
                        
                        {% if search_query %}
                            <span class="filter-badge">
                                Search: "{{ search_query }}"
                                <a href="?{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}{% endif %}" class="remove-filter">×</a>
                            </span>
                        {% endif %}
                        
                        {% if date_from %}
                            <span class="filter-badge">
                                From: {{ date_from }}
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if date_to %}date_to={{ date_to }}{% endif %}" class="remove-filter">×</a>
                            </span>
                        {% endif %}
                        
                        {% if date_to %}
                            <span class="filter-badge">
                                To: {{ date_to }}
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if date_from %}date_from={{ date_from }}{% endif %}" class="remove-filter">×</a>
                            </span>
                        {% endif %}
                        
                        <a href="?" class="clear-all-filters">Clear all</a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Gallery Grid (Masonry Style) -->
        <div class="row">
            <div class="col-12">
                <div class="gallery-masonry-grid">
                    {% for album in albums %}
                        <div class="gallery-album-card">
                            <a href="{% pageurl album %}" class="album-card-link">
                                
                                <!-- Album Cover Image -->
                                <div class="album-cover-wrapper">
                                    {% if album.get_cover_image %}
                                        {% image album.get_cover_image fill-600x400 as cover_img %}
                                        <img src="{{ cover_img.url }}" 
                                             alt="{{ album.album_title }}" 
                                             class="album-cover-image">
                                    {% else %}
                                        <div class="album-no-image">
                                            <i class="fas fa-images fa-3x"></i>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Photo Count Indicators (dots) -->
                                    {% if album.get_photo_count > 1 %}
                                        <div class="photo-indicators">
                                            {% for i in "x"|rjust:album.get_photo_count %}
                                                {% if forloop.counter <= 5 %}
                                                    <span class="indicator-dot"></span>
                                                {% endif %}
                                            {% endfor %}
                                            {% if album.get_photo_count > 5 %}
                                                <span class="indicator-more">+{{ album.get_photo_count|add:"-5" }}</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Album Info -->
                                <div class="album-info">
                                    <h3 class="album-title">{{ album.album_title }}</h3>
                                    <p class="album-meta">
                                        Folder - {{ album.album_date|date:"Y-m-d" }}
                                    </p>
                                </div>
                                
                            </a>
                            
                            <!-- Share Button -->
                            <button class="album-share-btn" 
                                    onclick="copyAlbumLink(event, '{{ request.scheme }}://{{ request.get_host }}{% pageurl album %}')">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                No photo albums found matching your criteria.
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if albums.has_other_pages %}
            <div class="pagination-wrapper mt-5">
                <nav aria-label="Gallery pagination">
                    <ul class="pagination justify-content-center">
                        
                        {% if albums.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ albums.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in albums.paginator.page_range %}
                            {% if albums.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > albums.number|add:'-3' and num < albums.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if albums.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ albums.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                    </ul>
                </nav>
            </div>
        {% endif %}
        
    </div>
    
</div>

<!-- Toast Notification for Copy Link -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="linkCopiedToast" class="toast" role="alert">
        <div class="toast-body bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            Link copied to clipboard!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Copy album link to clipboard
function copyAlbumLink(event, url) {
    event.preventDefault();
    event.stopPropagation();
    
    navigator.clipboard.writeText(url).then(function() {
        // Show toast notification
        const toastEl = document.getElementById('linkCopiedToast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }).catch(function(err) {
        alert('Failed to copy link: ' + err);
    });
}
</script>
{% endblock %}